<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rath Yatra Lucky Draw | Shrachi Agrimech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc, #dbeafe);
      font-family: 'Poppins', sans-serif;
    }
    .drawer {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .drawer.open {
      transform: translateX(0);
    }
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
  <!-- Header -->
  <header class="flex items-center justify-center p-4 bg-white/70 shadow-md backdrop-blur sticky top-0 z-20">
    <img src="https://www.shrachiagrimech.com/static/images/logo.png" alt="Shrachi Agrimech Logo" class="h-12 mr-4"/>
    <h1 class="text-2xl md:text-3xl font-bold text-emerald-700">Rath Yatra Lucky Draw</h1>
  </header>

  <!-- Drawer -->
  <div id="drawer" class="drawer fixed top-0 left-0 h-full w-72 bg-white/90 shadow-2xl p-4 z-30 backdrop-blur-lg">
    <h2 class="text-xl font-semibold mb-2">Enter Names</h2>
    <textarea id="nameInput" placeholder="Paste names here, one per line" class="w-full h-40 p-2 border rounded-lg"></textarea>
    <button id="addNames" class="mt-2 w-full bg-emerald-600 text-white px-3 py-2 rounded-lg hover:bg-emerald-700">Add Names</button>

    <h3 class="mt-4 font-medium">Participants</h3>
    <ul id="participantsList" class="space-y-1 mt-2 max-h-64 overflow-y-auto text-sm"></ul>
  </div>

  <!-- Drawer Toggle -->
  <button id="toggleDrawer" class="fixed top-20 left-2 z-40 bg-emerald-600 text-white rounded-full p-3 shadow-lg hover:bg-emerald-700">â˜°</button>

  <!-- Main Lucky Draw Area -->
  <main class="flex flex-col items-center justify-center p-6 mt-10">
    <div class="bg-white/60 backdrop-blur-lg rounded-3xl shadow-xl p-10 w-full max-w-xl flex flex-col items-center text-center">
      <div id="display" class="text-2xl md:text-4xl font-bold text-gray-800 h-16 flex items-center justify-center">
        Waiting for Draw...
      </div>
      <button id="drawBtn" class="mt-6 bg-gradient-to-r from-emerald-500 to-emerald-700 text-white px-8 py-3 rounded-2xl text-lg font-semibold hover:from-emerald-600 hover:to-emerald-800 shadow-md">
        ğŸ² Draw
      </button>
    </div>

    <!-- Past Winners -->
    <section class="mt-10 w-full max-w-xl">
      <h2 class="text-xl font-semibold mb-3">ğŸ† Past Winners</h2>
      <ul id="winnersList" class="space-y-2 text-center"></ul>
    </section>
  </main>

  <script>
    // DOM
    const drawer = document.getElementById("drawer");
    const toggleDrawer = document.getElementById("toggleDrawer");
    const addNamesBtn = document.getElementById("addNames");
    const nameInput = document.getElementById("nameInput");
    const participantsList = document.getElementById("participantsList");
    const drawBtn = document.getElementById("drawBtn");
    const displayEl = document.getElementById("display");
    const winnersList = document.getElementById("winnersList");

    let participants = [];
    let rolling = false;
    let intervalId = null;

    // Toggle drawer
    toggleDrawer.addEventListener("click", () => {
      drawer.classList.toggle("open");
    });

    // Escape HTML
    function escapeHtml(str) {
      return str.replace(/[&<>\\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // Add participants
    function renderParticipants() {
      participantsList.innerHTML = "";
      participants.forEach((name, i) => {
        const li = document.createElement("li");
        li.textContent = name;
        li.className = "bg-emerald-50 rounded px-2 py-1 flex justify-between items-center";
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "âŒ";
        removeBtn.className = "ml-2 text-red-600 hover:text-red-800";
        removeBtn.onclick = () => {
          participants.splice(i,1);
          renderParticipants();
        };
        li.appendChild(removeBtn);
        participantsList.appendChild(li);
      });
    }

    addNamesBtn.addEventListener("click", () => {
      const lines = nameInput.value.split(/\\n+/).map(l => l.trim()).filter(l => l);
      participants.push(...lines.map(escapeHtml));
      nameInput.value = "";
      renderParticipants();
    });

    function shuffle(arr) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function secureRandomIndex(max) {
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return array[0] % max;
    }

    function startRolling() {
      if (participants.length === 0 || rolling) return;
      rolling = true;
      displayEl.classList.remove("text-emerald-600");

      const sequence = shuffle(participants);
      let i = 0;
      intervalId = setInterval(() => {
        displayEl.textContent = sequence[i % sequence.length];
        i++;
      }, 70);

      drawBtn.disabled = true;

      // Auto-stop after 2â€“5s
      const stopAfter = 2000 + Math.random() * 3000;
      setTimeout(stopAndPick, stopAfter);
    }

    function stopAndPick() {
      if (!rolling) return;
      clearInterval(intervalId);
      rolling = false;

      const idx = secureRandomIndex(participants.length);
      const chosen = participants[idx];
      displayEl.textContent = "ğŸ‰ " + chosen + " ğŸ‰";
      displayEl.classList.add("text-emerald-600");

      participants.splice(idx, 1);
      renderParticipants();

      // Confetti burst
      confetti({ particleCount: 140, spread: 70, origin: { y: 0.3 } });
      confetti({ particleCount: 120, angle: 60, spread: 55, origin: { x: 0 } });
      confetti({ particleCount: 120, angle: 120, spread: 55, origin: { x: 1 } });

      // Add winner
      const li = document.createElement("li");
      li.className = "bg-white/70 rounded-xl px-3 py-2";
      li.textContent = chosen;
      winnersList.prepend(li);

      drawBtn.disabled = false;
    }

    drawBtn.addEventListener("click", startRolling);
  </script>
</body>
</html>
